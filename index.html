<script>
    // Replace these with your actual GitHub details
    const username = 'YOUR_USERNAME';
    const repo = 'YOUR_REPO_NAME';
    
    class JobAggregator {
        constructor() {
            this.jobs = [];
            this.filteredJobs = [];
            this.init();
        }

        async init() {
            await this.loadJobs();
            this.renderJobs();
            this.setupEventListeners();
            this.updateStats();
        }

        async loadJobs() {
            try {
                const jobsUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/data/jobs.json`;
                const response = await fetch(jobsUrl);
                
                if (response.ok) {
                    this.jobs = await response.json();
                    this.filteredJobs = [...this.jobs];
                    this.populateSourceFilter();
                    console.log(`âœ… Loaded ${this.jobs.length} jobs`);
                } else {
                    this.showError('Jobs database is being updated. Please check back in 10 minutes.');
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                this.showError('System is updating. Jobs will appear shortly.');
            }
        }

        populateSourceFilter() {
            const sourceFilter = document.getElementById('sourceFilter');
            const sources = [...new Set(this.jobs.map(job => job.source))];
            
            while (sourceFilter.children.length > 1) {
                sourceFilter.removeChild(sourceFilter.lastChild);
            }
            
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceFilter.appendChild(option);
            });
        }

        renderJobs() {
            const container = document.getElementById('jobsContainer');
            
            if (this.filteredJobs.length === 0) {
                container.innerHTML = '<div class="no-jobs">No jobs match your filters</div>';
                return;
            }

            container.innerHTML = this.filteredJobs.map(job => {
                // Validate and fix URL
                let jobUrl = job.url || '#';
                if (!jobUrl.startsWith('http')) {
                    jobUrl = 'https://' + jobUrl;
                }
                
                // Calculate days until expiry
                const expires = new Date(job.expires);
                const now = new Date();
                const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
                
                return `
                    <div class="job-card">
                        <div class="job-header">
                            <div>
                                <h3 class="job-title">${this.escapeHtml(job.title)}</h3>
                                <div class="job-company">${this.escapeHtml(job.company)}</div>
                            </div>
                            <span class="job-source">${this.escapeHtml(job.source)}</span>
                        </div>
                        <div class="job-description">${this.escapeHtml(job.description)}</div>
                        <div class="job-meta">
                            <span>
                                Posted: ${new Date(job.date).toLocaleDateString()} â€¢ 
                                Expires in: ${daysLeft} days
                            </span>
                            <a href="${jobUrl}" target="_blank" rel="noopener noreferrer" class="apply-btn">
                                Apply Now â€º
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        showError(message) {
            const container = document.getElementById('jobsContainer');
            container.innerHTML = `
                <div class="no-jobs">
                    <h3>ðŸ”„ System Update</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const sourceFilter = document.getElementById('sourceFilter');

            const debounce = (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };

            searchInput.addEventListener('input', debounce(() => this.filterJobs(), 300));
            sourceFilter.addEventListener('change', () => this.filterJobs());
        }

        filterJobs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const source = document.getElementById('sourceFilter').value;

            this.filteredJobs = this.jobs.filter(job => {
                const matchesSearch = !searchTerm || 
                    job.title.toLowerCase().includes(searchTerm) ||
                    job.company.toLowerCase().includes(searchTerm) ||
                    job.description.toLowerCase().includes(searchTerm);
                
                const matchesSource = !source || job.source === source;
                
                return matchesSearch && matchesSource;
            });

            this.renderJobs();
            this.updateStats();
        }

        updateStats() {
            document.getElementById('jobCount').textContent = this.filteredJobs.length;
            document.getElementById('lastUpdated').textContent = 
                `Last updated: ${new Date().toLocaleString()}`;
        }

        escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new JobAggregator();
    });
</script>
